# ESP8266无线传输JPEG图像使用说明（透传模式）

## 概述

本项目已集成ESP8266 WiFi模块支持，使用**透传模式**通过WiFi无线传输JPEG图像数据到电脑端实时预览。

**工作模式：** ESP8266作为TCP客户端，连接到电脑端的TCP服务器。

## 硬件连接

### ESP8266模块连接
```
ESP8266模块  →  STM32F407开发板
─────────────────────────────────
VCC          →  3.3V (需要500mA以上电流，建议外接电源)
GND          →  GND
TX           →  PA3 (USART2_RX)
RX           →  PA2 (USART2_TX)
```

**重要提示：**
- ESP8266需要单独供电，建议使用3.3V 500mA以上的电源
- 不要直接从STM32的3.3V引脚取电，可能导致供电不足
- 确保ESP8266和STM32共地(GND)

## 软件配置

### 1. 修改WiFi配置

打开 `Drivers/BSP/ESP8266/esp8266.c` 文件，找到 `esp8266_init()` 函数，修改WiFi名称和密码：

```c
/* 4. 连接WiFi (需要根据实际情况修改) */
res = esp8266_connect_ap("EVEB", "123456789");
```

将 `"EVEB"` 和 `"123456789"` 替换为你的WiFi名称和密码。

### 2. 修改TCP服务器地址和端口

在 `esp8266_init()` 函数中，找到连接TCP服务器的代码：

```c
/* 6. 连接TCP服务器 (需要根据实际情况修改) */
res = esp8266_connect_tcp_server("192.168.0.8", 8266);
```

修改为你的电脑IP地址和端口号（默认8266）。

**如何查看电脑IP地址：**
- Windows: 打开命令提示符，输入 `ipconfig`，查看IPv4地址
- Linux/Mac: 打开终端，输入 `ifconfig` 或 `ip addr`

### 3. 波特率设置

当前代码已设置为115200波特率，这是ESP8266推荐的波特率。如果需要修改，可以在以下位置调整：

- `Drivers/BSP/ESP8266/esp8266.h` 中的 `ESP8266_BAUDRATE` 宏定义
- `User/main.c` 中的 `usart2_init(115200)` 调用

## 电脑端接收软件（重要：必须先启动TCP服务器）

### 方案1：使用网络调试助手（推荐）

**重要：** ESP8266是TCP客户端，电脑端需要先启动TCP服务器！

1. 下载网络调试助手（如：NetAssist、TCP/UDP调试助手等）
2. **选择TCP服务器模式**（不是客户端！）
3. 设置监听端口（默认8266，与代码中的端口一致）
4. 点击"启动服务器"或"监听"
5. 等待ESP8266连接（连接成功后会显示客户端连接）
6. 接收到的数据即为JPEG图像数据

**注意：** 
- 电脑端必须先启动TCP服务器，再运行STM32程序
- 确保电脑防火墙允许该端口
- 确保电脑和ESP8266在同一WiFi网络

### 方案2：使用Python脚本接收（TCP服务器模式）

创建一个Python脚本来接收和显示图像：

```python
import socket
import cv2
import numpy as np

# TCP服务器端口（与ESP8266代码中的端口一致）
TCP_PORT = 8266

# 创建TCP服务器
server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
server.bind(('0.0.0.0', TCP_PORT))  # 监听所有网络接口
server.listen(1)  # 允许1个客户端连接

print(f"TCP Server started on port {TCP_PORT}")
print("Waiting for ESP8266 to connect...")

# 等待ESP8266连接
client, addr = server.accept()
print(f"ESP8266 connected from {addr}")

jpeg_data = b""
frame_count = 0

print("Receiving JPEG data...")
print("Press 'q' to quit")

try:
    while True:
        # 接收数据
        data = client.recv(4096)
        if not data:
            print("Connection closed by ESP8266")
            break
        
        jpeg_data += data
        
        # 查找JPEG帧边界
        # 数据格式: [4字节长度][JPEG数据][0xFF 0xD9结束标识]
        while len(jpeg_data) >= 4:
            # 读取长度信息（大端序）
            jpeg_len = int.from_bytes(jpeg_data[0:4], byteorder='big')
            
            # 检查数据是否完整（至少需要长度+数据+结束标识）
            if len(jpeg_data) >= 4 + jpeg_len + 2:
                # 提取JPEG数据（跳过4字节长度）
                jpeg_frame = jpeg_data[4:4+jpeg_len]
                
                # 解码并显示
                nparr = np.frombuffer(jpeg_frame, np.uint8)
                img = cv2.imdecode(nparr, cv2.IMREAD_COLOR)
                
                if img is not None:
                    cv2.imshow('ESP8266 Camera', img)
                    frame_count += 1
                    print(f"Frame {frame_count} received, size: {jpeg_len} bytes")
                else:
                    print(f"Failed to decode JPEG frame {frame_count + 1}")
                
                # 移除已处理的数据
                jpeg_data = jpeg_data[4+jpeg_len+2:]
            else:
                # 数据不完整，继续接收
                break
        
        if cv2.waitKey(1) & 0xFF == ord('q'):
            break

except KeyboardInterrupt:
    print("\nStopped by user")
except Exception as e:
    print(f"Error: {e}")
finally:
    client.close()
    server.close()
    cv2.destroyAllWindows()
    print("TCP Server closed")
```

### 方案3：使用串口工具（不推荐）

如果ESP8266配置为透传模式，也可以使用串口工具，但需要先通过AT指令配置ESP8266。

## 数据格式说明

JPEG数据包格式：
```
[4字节长度(大端序)][JPEG图像数据][0xFF 0xD9结束标识]
```

- 前4字节：JPEG数据长度（大端序，uint32_t）
- 中间：JPEG图像数据（从0xFF 0xD8开始）
- 最后2字节：0xFF 0xD9（结束标识）

## 使用步骤

1. **硬件连接**
   - 按照上述连接方式连接ESP8266
   - 确保ESP8266单独供电

2. **软件配置**
   - 修改WiFi名称和密码
   - 编译并下载程序到STM32

3. **运行程序**
   - 上电后，程序会自动初始化ESP8266
   - LCD会显示初始化状态
   - 如果初始化成功，会显示ESP8266的IP地址（通过串口1输出）

4. **电脑端启动TCP服务器**
   - **重要：必须先启动TCP服务器，再运行STM32程序！**
   - 使用网络调试助手，选择TCP服务器模式，监听端口8266
   - 或运行Python脚本启动TCP服务器
   - 等待ESP8266连接

5. **运行STM32程序**
   - 上电后，程序会自动初始化ESP8266
   - LCD会显示初始化状态
   - 如果初始化成功，ESP8266会自动连接到电脑的TCP服务器
   - 开始接收JPEG图像数据

5. **选择模式**
   - 按KEY1进入JPEG模式
   - 图像数据会通过ESP8266无线传输

## 故障排除

### ESP8266初始化失败

1. **检查硬件连接**
   - 确认TX/RX是否正确连接（ESP8266的TX接STM32的RX，ESP8266的RX接STM32的TX）
   - 确认供电是否充足（建议外接3.3V电源）

2. **检查WiFi配置**
   - 确认WiFi名称和密码正确
   - 确认WiFi信号强度足够

3. **查看串口输出**
   - 通过串口1（115200波特率）查看详细的错误信息
   - 检查AT指令响应

### 接收不到数据

1. **检查TCP服务器是否启动**
   - **最重要：电脑端必须先启动TCP服务器！**
   - 确认TCP服务器正在监听（不是客户端模式）
   - 确认端口号与代码中一致（默认8266）

2. **检查网络连接**
   - 确认电脑和ESP8266在同一WiFi网络
   - 确认防火墙没有阻止连接
   - 确认电脑IP地址与代码中配置一致

3. **检查ESP8266连接状态**
   - 查看串口1输出，确认ESP8266是否成功连接到TCP服务器
   - 如果连接失败，检查IP地址和端口是否正确

4. **检查数据格式**
   - 确认接收软件能正确解析数据包格式

### 图像不完整或卡顿

1. **降低分辨率**
   - 使用KEY_UP按键降低JPEG分辨率（如QVGA 320x240）
   - 高分辨率会导致数据量大，传输可能跟不上

2. **检查WiFi信号**
   - 确保WiFi信号强度足够
   - 避免距离路由器太远

3. **优化波特率**
   - 可以尝试提高波特率到230400（需要修改代码）

## 性能优化建议

1. **降低分辨率**：使用QVGA(320x240)或更小的分辨率
2. **降低帧率**：在代码中添加帧率控制
3. **使用压缩**：OV2640已内置JPEG压缩
4. **优化网络**：使用5GHz WiFi（如果ESP8266支持）

## 注意事项

1. **电脑端必须先启动TCP服务器，再运行STM32程序！**
2. ESP8266需要单独供电，不要从STM32取电
3. 确保ESP8266和STM32共地
4. 高分辨率图像数据量大，可能导致传输延迟
5. 建议使用QVGA(320x240)分辨率进行实时预览
6. 确保电脑和ESP8266在同一WiFi网络
7. 确保电脑防火墙允许TCP端口8266
8. 如果不需要ESP8266功能，可以注释掉ESP8266初始化代码，直接使用串口2连接电脑

## 透传模式初始化流程

ESP8266按照以下AT指令序列初始化：

1. `AT+RESTORE` - 恢复出厂设置
2. `AT+CWMODE=1` - 设置Station模式
3. `AT+RST` - 复位ESP8266
4. `AT+CWJAP="SSID","PWD"` - 连接WiFi
5. `AT+CIPMODE=1` - 设置透传模式
6. `AT+CIPSTART="TCP","IP",PORT` - 连接TCP服务器
7. `AT+CIPSEND` - 开启透传

初始化成功后，所有通过串口2发送的数据都会直接透传到TCP服务器。

## 代码修改说明

如果不想使用ESP8266，想直接通过串口2连接电脑：

1. 在 `User/main.c` 中注释掉ESP8266相关代码
2. 将 `usart2_init(115200)` 改回 `usart2_init(921600)`（如果需要高速传输）
3. 使用USB转串口线连接PA2/PA3到电脑

## 技术支持

如有问题，请查看：
- 串口1输出的调试信息
- ESP8266的AT指令响应
- 网络连接状态


