# STM32F407 摄像头实验项目

## ? 项目简介

本项目基于正点原子探索者F407开发板，实现了OV2640摄像头模块的完整功能，包括图像采集、JPEG压缩、WiFi无线传输以及舵机自动追踪功能。项目支持JPEG和RGB565两种图像模式，可通过ESP8266模块实现无线图像传输，并集成了光斑检测和双轴舵机追踪系统。

## ? 主要功能

- **? 摄像头采集**
  - 支持OV2640摄像头模块
  - JPEG模式：支持QQVGA到UXGA多种分辨率（160x120 ~ 1600x1200）
  - RGB565模式：实时显示在LCD屏幕（已注释，可启用）
  - DCMI接口硬件采集，DMA双缓冲传输

- **? 无线传输**
  - ESP8266 WiFi模块支持
  - TCP透传模式，实时传输JPEG图像数据
  - 支持电脑端TCP服务器接收和显示

- **? 光斑检测与追踪**
  - 实时光斑检测算法（支持JPEG和RGB565模式）
  - 双轴舵机自动追踪（水平/垂直）
  - 平滑滤波算法，减少抖动
  - 死区控制，避免微小抖动

- **? 控制功能**
  - 手动模式：按键控制舵机角度
  - 自动模式：根据光斑位置自动追踪
  - 模式切换：KEY0按键切换手动/自动模式
  - 舵机开机自检动作

## ? 硬件要求

### 开发板
- 正点原子 探索者F407开发板
- STM32F407ZGT6微控制器

### 外设模块
- **OV2640摄像头模块**（必需）
- **ESP8266 WiFi模块**（可选，用于无线传输）
- **PCA9685舵机驱动板**（可选，用于追踪功能）
- **双轴舵机云台**（可选，用于追踪功能）
- **TFTLCD显示屏**（可选，用于RGB565模式显示）

### 硬件连接

#### OV2640摄像头连接
```
摄像头模块     →    STM32F407开发板
─────────────────────────────────────
OV_D0~D7      →    PC6/PC7/PC8/PC9/PC11/PB6/PE5/PE6
OV_SCL        →    PD6
OV_SDA        →    PD7
OV_VSYNC      →    PB7
OV_HREF       →    PA4
OV_PCLK       →    PA6
OV_PWDN       →    PG9
OV_RESET      →    PG15
OV_XCLK       →    PA8
```

#### ESP8266连接（可选）
```
ESP8266模块   →    STM32F407开发板
─────────────────────────────────────
VCC           →    3.3V (需外接电源，500mA以上)
GND           →    GND
TX            →    PA3 (USART2_RX)
RX            →    PA2 (USART2_TX)
```

#### 按键功能
- **KEY0** (PE4): 模式切换（手动 ? 自动）
- **KEY1** (PE3): 手动模式下向左转
- **KEY2** (PE2): 手动模式下向右转
- **WK_UP** (PA0): 手动模式下向上转
- **KEY4**: 手动模式下向下转（需自定义）

#### LED指示
- **LED0** (PF9): 系统运行指示（闪烁）
- **LED1** (PF10): 帧中断指示（闪烁）

## ? 项目结构

```
实验35 摄像头实验/
├── Drivers/                    # 驱动层
│   ├── BSP/                    # 板级支持包
│   │   ├── DCMI/              # DCMI接口驱动
│   │   ├── OV2640/            # OV2640摄像头驱动
│   │   ├── ESP8266/           # ESP8266 WiFi驱动
│   │   ├── SERVO_TRACK/       # 舵机追踪模块
│   │   ├── Servo/             # 舵机驱动
│   │   ├── LCD/               # LCD显示驱动
│   │   ├── LED/               # LED驱动
│   │   ├── KEY/               # 按键驱动
│   │   └── TIMER/             # 定时器驱动
│   ├── CMSIS/                 # CMSIS标准接口
│   ├── STM32F4xx_HAL_Driver/  # HAL库驱动
│   └── SYSTEM/                # 系统文件
├── Middlewares/               # 中间件
│   └── USMART/               # USMART调试工具
├── User/                      # 用户代码
│   ├── main.c                 # 主程序
│   ├── stm32f4xx_it.c         # 中断服务函数
│   └── stm32f4xx_hal_conf.h   # HAL库配置
├── Projects/                  # 工程文件
│   └── MDK-ARM/              # Keil工程文件
├── Output/                    # 编译输出
├── ESP8266_使用说明.md        # ESP8266使用说明
└── README.md                  # 本文件
```

## ? 快速开始

### 1. 环境准备

- **开发环境**: Keil MDK-ARM 5.x
- **编译器**: ARM Compiler 5/6
- **调试器**: ST-Link / J-Link
- **串口工具**: 115200波特率（串口1用于调试，串口2用于ESP8266）

### 2. 编译与下载

1. 使用Keil MDK打开 `Projects/MDK-ARM/atk_f407.uvprojx`
2. 编译工程（F7）
3. 下载到开发板（F8）
4. 复位开发板

### 3. 配置ESP8266（如使用无线传输）

1. 打开 `Drivers/BSP/ESP8266/esp8266.c`
2. 修改WiFi配置：
   ```c
   esp8266_connect_ap("你的WiFi名称", "WiFi密码");
   ```
3. 修改TCP服务器地址：
   ```c
   esp8266_connect_tcp_server("192.168.0.8", 8266);
   ```
4. 重新编译下载

### 4. 运行程序

1. **串口调试**：连接串口1（PA9/PA10），波特率115200，查看调试信息
2. **ESP8266模式**：
   - 电脑端先启动TCP服务器（端口8266）
   - 运行STM32程序，ESP8266会自动连接
   - 接收JPEG图像数据
3. **串口2模式**：
   - 如不使用ESP8266，可注释ESP8266初始化代码
   - 直接通过串口2（PA2/PA3）连接电脑接收数据

## ? 功能说明

### JPEG模式（当前使用）

- **分辨率**: 固定为QVGA (320x240)
- **参数**: 对比度、饱和度、特效已固定
- **传输**: 通过ESP8266或串口2发送JPEG数据
- **光斑检测**: 简化采样检测（JPEG模式下精度较低）

### RGB565模式（已注释，可启用）

- **显示**: 直接显示在LCD屏幕
- **分辨率**: 支持多种分辨率，可缩放显示
- **光斑检测**: 高精度实时检测（推荐用于追踪）

### 舵机追踪功能

#### 手动模式
- KEY0: 切换为自动模式
- KEY1: 向左转（水平-10度）
- KEY2: 向右转（水平+10度）
- WK_UP: 向上转（垂直-10度）
- KEY4: 向下转（垂直+10度）

#### 自动模式
- 自动检测光斑位置
- 平滑追踪到目标位置
- 目标丢失后自动回中
- KEY0: 切换为手动模式

### 参数配置

在 `main.c` 中可以修改以下参数：

```c
// JPEG模式参数（固定）
const uint8_t effect = 0;        // 特效：Normal
const uint8_t saturation = 2;    // 饱和度：默认值
const uint8_t contrast = 2;      // 对比度：默认值
const uint8_t size = 2;          // 分辨率：QVGA 320*240

// 舵机追踪参数
ServoTrack_SetSmoothFactor(0.3f);  // 平滑系数（0~1）
ServoTrack_SetDeadZone(10);        // 死区半径（像素）
```

## ? ESP8266无线传输使用

详细说明请参考 [ESP8266_使用说明.md](./ESP8266_使用说明.md)

### 快速步骤

1. **硬件连接**: 按照上述连接方式连接ESP8266（需外接电源）
2. **配置WiFi**: 修改代码中的WiFi名称和密码
3. **配置服务器**: 修改TCP服务器IP和端口
4. **启动服务器**: 电脑端先启动TCP服务器（端口8266）
5. **运行程序**: STM32程序会自动连接并传输数据

### 数据格式

```
[4字节长度(大端序)][JPEG图像数据][0xFF 0xD9结束标识]
```

## ? 调试功能

### USMART调试工具

支持通过串口1调用以下函数：

```c
ov2640_write_reg(reg, value);  // 写OV2640寄存器
ov2640_read_reg(reg);           // 读OV2640寄存器
```

### 串口输出信息

- 摄像头初始化状态
- ESP8266连接状态
- 舵机追踪信息
- JPEG数据长度
- 光斑检测结果

## ?? 系统配置

### 时钟配置
- 系统时钟: 168MHz
- HCLK: 168MHz
- APB1: 42MHz
- APB2: 84MHz

### 串口配置
- **串口1** (USART1): 115200波特率，用于调试和USMART
- **串口2** (USART2): 115200波特率，用于ESP8266或直接连接电脑

### 定时器配置
- **定时器6**: 10KHz计数频率，1秒中断一次，用于帧率统计

## ? 故障排除

### 摄像头初始化失败
- 检查硬件连接是否正确
- 确认OV2640模块供电正常
- 查看串口输出的错误信息

### ESP8266连接失败
- 确认ESP8266单独供电（500mA以上）
- 检查WiFi名称和密码是否正确
- 确认电脑端TCP服务器已启动
- 检查防火墙设置

### 舵机不工作
- 确认PCA9685驱动板供电正常（5V）
- 检查I2C连接是否正确
- 查看串口输出的舵机状态信息

### 图像传输卡顿
- 降低JPEG分辨率（使用QVGA）
- 检查WiFi信号强度
- 确认TCP服务器处理速度

### 光斑检测不准确
- JPEG模式下检测精度较低，建议切换到RGB565模式
- 调整光斑检测阈值
- 确保光照条件良好

## ? 注意事项

1. **供电要求**: ESP8266需要单独供电，不要从STM32取电
2. **TCP服务器**: 使用ESP8266时，电脑端必须先启动TCP服务器
3. **分辨率**: 高分辨率会导致数据量大，建议使用QVGA进行实时传输
4. **光斑检测**: JPEG模式下检测精度较低，RGB565模式精度更高
5. **舵机角度**: 舵机角度范围限制在0~180度
6. **串口配置**: 确保串口工具波特率设置为115200

## ? 相关文档

- [ESP8266使用说明](./ESP8266_使用说明.md)
- [舵机追踪模块说明](./Drivers/BSP/SERVO_TRACK/README.md)
- [正点原子官方文档](www.openedv.com/docs/index.html)

## ?? 开发信息

- **开发平台**: 正点原子 探索者F407开发板
- **开发环境**: Keil MDK-ARM
- **HAL库版本**: STM32F4xx HAL Driver
- **摄像头模块**: ALIENTEK OV2640
- **WiFi模块**: ESP8266

## ? 许可证

Copyright (c) 2020-2032, 广州市星翼电子科技有限公司

## ? 相关链接

- **公司网址**: www.alientek.com
- **技术论坛**: www.openedv.com
- **在线视频**: www.yuanzige.com
- **购买地址**: openedv.taobao.com

## ? 技术支持

如有问题，请查看：
- 串口1输出的调试信息
- ESP8266的AT指令响应
- 网络连接状态
- 技术论坛: www.openedv.com

---

**版本**: v1.0  
**更新日期**: 2025-01-xx

